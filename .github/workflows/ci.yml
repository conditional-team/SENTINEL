# ═══════════════════════════════════════════════════════════════════════════════
#  SENTINEL SHIELD - GitHub Actions CI/CD Pipeline
#  Author: SENTINEL Team
# ═══════════════════════════════════════════════════════════════════════════════

name: CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  release:
    types: [published]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ═══════════════════════════════════════════════════════════════════════════
  #                              LINT & FORMAT
  # ═══════════════════════════════════════════════════════════════════════════
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Go
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: api/go.sum
      - name: Go Lint
        uses: golangci/golangci-lint-action@v4
        with:
          working-directory: api

      # Rust
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('decompiler/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      - name: Rust Format Check
        run: cargo fmt --manifest-path decompiler/Cargo.toml -- --check
      - name: Rust Clippy
        run: cargo clippy --manifest-path decompiler/Cargo.toml -- -D warnings

      # Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: analyzer/requirements.txt
      - name: Python Lint
        run: |
          pip install ruff mypy
          ruff check analyzer/
          mypy analyzer/src

      # Frontend
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Frontend Lint
        run: |
          cd frontend
          npm ci
          npm run lint

      # Solidity
      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
      - name: Solidity Format Check
        run: |
          cd contracts
          forge fmt --check

  # ═══════════════════════════════════════════════════════════════════════════
  #                              TEST
  # ═══════════════════════════════════════════════════════════════════════════
  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      # Go Tests
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.22'
          cache: true
          cache-dependency-path: api/go.sum
      - name: Go Tests
        run: |
          cd api
          go test -v -race -coverprofile=coverage.out ./...
          # Run tests from tests/go/ directory as well
          cd ..
          go test -v -race ./tests/go/... || true
      - name: Upload Go Coverage
        uses: codecov/codecov-action@v4
        with:
          files: api/coverage.out
          flags: go

      # Rust Tests
      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache Cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin
            ~/.cargo/registry
            ~/.cargo/git
          key: ${{ runner.os }}-cargo-${{ hashFiles('decompiler/Cargo.toml') }}
          restore-keys: |
            ${{ runner.os }}-cargo-
      - name: Rust Tests
        run: cargo test --manifest-path decompiler/Cargo.toml --verbose

      # Python Tests
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'
          cache-dependency-path: analyzer/requirements.txt
      - name: Python Tests
        run: |
          cd analyzer
          pip install -r requirements.txt
          pip install pytest pytest-cov pytest-asyncio
          # Run tests from tests/python/ directory
          pytest -v ../tests/python/ --cov=src --cov-report=xml
      - name: Upload Python Coverage
        uses: codecov/codecov-action@v4
        with:
          files: analyzer/coverage.xml
          flags: python

      # Solidity Tests
      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1
      - name: Solidity Tests
        run: |
          cd contracts
          forge test -v --gas-report
          # Run additional tests from tests/solidity/ if they exist
          forge test -v --match-path ../tests/solidity/*.sol || true

      # Frontend
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      - name: Frontend Tests
        run: |
          cd frontend
          npm ci
          npm run test:coverage
      - name: Upload Frontend Coverage
        uses: codecov/codecov-action@v4
        with:
          files: frontend/coverage/lcov.info
          flags: frontend

  # ═══════════════════════════════════════════════════════════════════════════
  #                              BUILD
  # ═══════════════════════════════════════════════════════════════════════════
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: test
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        service: [api, decompiler, analyzer, frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Container Registry
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-${{ matrix.service }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=sha

      - name: Build and Push
        uses: docker/build-push-action@v5
        with:
          context: ./${{ matrix.service }}
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ═══════════════════════════════════════════════════════════════════════════
  #                          DEPLOY CONTRACTS
  # ═══════════════════════════════════════════════════════════════════════════
  deploy-contracts:
    name: Deploy Contracts
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'release'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Setup Foundry
        uses: foundry-rs/foundry-toolchain@v1

      - name: Deploy to Mainnet
        env:
          PRIVATE_KEY: ${{ secrets.DEPLOYER_PRIVATE_KEY }}
          ETHERSCAN_API_KEY: ${{ secrets.ETHERSCAN_API_KEY }}
          RPC_URL: ${{ secrets.ETH_RPC_URL }}
        run: |
          cd contracts
          forge script script/Deploy.s.sol:DeployScript \
            --rpc-url $RPC_URL \
            --broadcast \
            --verify

  # ═══════════════════════════════════════════════════════════════════════════
  #                          DEPLOY SERVICES
  # ═══════════════════════════════════════════════════════════════════════════
  deploy:
    name: Deploy Services
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to Production
        env:
          DEPLOY_KEY: ${{ secrets.DEPLOY_KEY }}
          DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
        run: |
          echo "Deploying to production..."
          # Add your deployment script here
          # Example: SSH to server and docker-compose pull && docker-compose up -d

  # ═══════════════════════════════════════════════════════════════════════════
  #                          SECURITY SCAN
  # ═══════════════════════════════════════════════════════════════════════════
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      # Dependency audit
      - name: Go Security Scan
        uses: securego/gosec@master
        with:
          args: ./api/...

      - name: Rust Security Audit
        run: |
          cargo install cargo-audit
          cargo audit --file decompiler/Cargo.toml

      - name: Python Safety Check
        run: |
          pip install safety
          safety check -r analyzer/requirements.txt

      # Smart contract security
      - name: Slither Analysis
        uses: crytic/slither-action@v0.3.0
        with:
          target: 'contracts/'
          slither-args: '--exclude-dependencies'
          fail-on: 'high'
